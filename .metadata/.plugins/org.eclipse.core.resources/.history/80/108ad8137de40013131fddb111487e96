/**
 * Project: SampleGame01
 * Package: game.engine
 * Author: EltonJohn
 * Date: May 23, 2014
 * Time: 6:36:52 PM
 */
package game.engine;

import static org.lwjgl.opengl.GL11.*; //Use GL11
import static minecraft2d.World.BLOCK_SIZE;
import static minecraft2d.World.saveFile;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;

import javax.swing.JOptionPane;

import minecraft2d.BlockGrid;
import minecraft2d.BlockType;

import org.lwjgl.LWJGLException;
import org.lwjgl.input.Keyboard;
import org.lwjgl.input.Mouse;
import org.lwjgl.opengl.Display;
import org.lwjgl.opengl.DisplayMode;
import org.newdawn.slick.opengl.Texture;
import org.newdawn.slick.opengl.TextureLoader;

public class Main {
	public static BlockGrid grid;
	public static BlockType selection;
	public static int SCREEN_WIDTH =640,SCREEN_HEIGHT =480;
	public static Texture background ;
	public static String backgroundPath = "res/images/background.png";
	
	public static void createDisplay() {
		try {
			Display.setDisplayMode(new DisplayMode(SCREEN_WIDTH,SCREEN_HEIGHT));
		} catch (LWJGLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		Display.setTitle("Minecraft2D");
		for(BlockType type:BlockType.values()){
			type.loadTextures();
		}
		grid = new BlockGrid();
		selection = BlockType.STONE;
		try {
			Display.create();
		} catch (LWJGLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
//		glClearColor(0.0f, 0.0f, 0.0f, 0.0f);  
//			glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
//			glViewport(0,0,SCREEN_WIDTH,SCREEN_HEIGHT);
//		glMatrixMode(GL_MODELVIEW);
		
		glMatrixMode(GL_PROJECTION);
		glLoadIdentity();
		glOrtho(0, SCREEN_WIDTH, SCREEN_HEIGHT, 0, 1, -1);
		glMatrixMode(GL_MODELVIEW);
		glEnable(GL_TEXTURE_2D);
		
		setUpBackground();
		
	}

	private static void setUpBackground() {
		Texture result = null;
		try {
			result = TextureLoader.getTexture("PNG", new FileInputStream(
					new File(backgroundPath)));
		} catch (FileNotFoundException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		background = result;
	}

	public static void gameLoop() { 
		while(!Display.isCloseRequested())	{
			//Drawing code
			glClear(GL_COLOR_BUFFER_BIT);
			drawBackground();
			grid.draw();
			
			//get user input
			input();
			Display.update();
			Display.sync(60);
		}
	}
	private static void drawBackground() {
		background.bind();
		glLoadIdentity();
		glTranslatef(0, 0, 0);
		glBegin(GL_QUADS);
			glTexCoord2f(0,0);
			glVertex2f(0,0);
			glTexCoord2f(1,0);
			glVertex2f(SCREEN_WIDTH,0);
			glTexCoord2f(1, 1);
			glVertex2f(SCREEN_WIDTH, SCREEN_HEIGHT);
			glTexCoord2f(0, 1);
			glVertex2f(0, SCREEN_HEIGHT);
		glEnd();
		glLoadIdentity();
	}

	public static void input(){
		int mousex = Mouse.getX();
		int mousey = SCREEN_HEIGHT - Mouse.getY();
		boolean mouseClicked =  Mouse.isButtonDown(0);
		if(mouseClicked){
			int grid_x = Math.round(mousex/BLOCK_SIZE);
			int grid_y = Math.round(mousey/BLOCK_SIZE);
			grid.setAt(grid_x, grid_y, selection);
		}
		while(Keyboard.next()){
			if(Keyboard.getEventKey() == Keyboard.KEY_S){
				grid.save(new File(saveFile));//TODO move this somewhere else
			}
			if(Keyboard.getEventKey() == Keyboard.KEY_L){
				grid.load(new File(saveFile));//TODO move this somewhere else
				JOptionPane.showMessageDialog(null, "Done loading");
			}
			if(Keyboard.getEventKey() == Keyboard.KEY_1){
				selection= BlockType.STONE;
			}
			if(Keyboard.getEventKey() == Keyboard.KEY_2){
				selection= BlockType.DIRT;
			}
			if(Keyboard.getEventKey() == Keyboard.KEY_3){
				selection= BlockType.GRASS;
			}
			if(Keyboard.getEventKey() == Keyboard.KEY_4){
				selection= BlockType.AIR;
			}
		}
	}

	public static void quit() {
		Display.destroy();
	}
	
	public static void main(String[] args) {
		createDisplay();
		gameLoop();
		quit();
	}
	
}